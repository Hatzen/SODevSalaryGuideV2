version: '3'
services:
  postgres-database:
    build:
      context: ./database
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      # always use postgres database
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - ./data/database:/var/lib/postgresql/data

  # https://www.section.io/engineering-education/dockerize-a-rabbitmq-instance/
  rabbitmq3:
    container_name: "rabbitmq"
    image: rabbitmq:3.8-management-alpine
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      # AMQP protocol port
      - "${RABBIT_MQ_PORT}:5672"
      # HTTP management UI
      - "${RABBIT_MQ_ADMIN_UI_PORT}:15672"

  application-http-api:
    build:
      dockerfile: ./application-http-api/Dockerfile
      context: ../../../
    ports:
      - "8081:8081"
    depends_on:
      - postgres-database
      - rabbitmq3

  application-batch-worker-intake:
    build:
      dockerfile: ./application-batch-worker-intake/Dockerfile
      context: ../../../
    ports:
      - "8082:8082"
    depends_on:
      - postgres-database
      - rabbitmq3